// ==UserScript==
// @name Magento CodeMirror with Save Fix
// @namespace benz.magento.codemirror
// @version 1.3
// @description Syntax highlighting with guaranteed save in Magento Page Builder/Admin
// @match https://dev4.abenson-shop.online/awesomedigital*
// @match https://dev4.abenson-shop.online/awesomedigital/cms/*
// @match https://web.abenson.com/awesomedigital/*
// @match *://web.abenson.com/awesomedigital/*
// @match https://web.abenson.com/awesomedigital/*
// @match https://*/admin/*
// @match https://*/backend/*
// @match https://*/*/admin/*
// @match https://*/*/backend/*
// @grant GM_addStyle
// @grant GM_getResourceText
// @run-at document-idle
// @require https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js
// @require https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/xml/xml.min.js
// @require https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js
// @require https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/css/css.min.js
// @require https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/htmlmixed/htmlmixed.min.js
// @resource cmCSS https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css
// @resource cmTheme https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/material.min.css
// ==/UserScript==

(function() {
const baseCSS = GM_getResourceText('cmCSS') || '';
const themeCSS = GM_getResourceText('cmTheme') || '';
GM_addStyle(baseCSS + themeCSS + `
.cm-wrapper { border: 1px solid #c2c7cf; border-radius: 8px; margin-bottom: .5rem; }
.CodeMirror { height: 600px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 14px; }
.cm-toolbar { display:flex; gap:.5rem; align-items:center; margin: .25rem 0; }
.cm-btn { cursor:pointer; padding:.2rem .5rem; border:1px solid #dadde2; border-radius:6px; background:#fff; }
`);

const isTextAreaCandidate = el => {
if (!(el instanceof HTMLTextAreaElement)) return false;
if (el.dataset.cmApplied === '1') return false;
if (el.classList.contains('admin__control-textarea') || el.rows >= 6) return true;
if (el.matches('[data-code], [data-lang]')) return true;
return false;
};

const detectMode = el => {
const lang = (el.dataset.lang || el.getAttribute('data-language') || '').toLowerCase();
if (lang === 'css') return 'css';
if (lang === 'js' || lang === 'javascript') return 'javascript';
return 'htmlmixed';
};

const triggerEvents = ta => {
['input', 'change'].forEach(evtName => {
const evt = new Event(evtName, { bubbles: true });
ta.dispatchEvent(evt);
});
};

const attachSaveListeners = cm => {
const buttons = Array.from(document.querySelectorAll('button[id*="save"], [data-ui-id*="save"]'));
buttons.forEach(btn => {
if (btn.dataset.cmListener) return;
btn.dataset.cmListener = '1';
btn.addEventListener('mousedown', () => { cm.save(); triggerEvents(cm.getTextArea()); });
btn.addEventListener('click', () => { cm.save(); triggerEvents(cm.getTextArea()); });
});
};

const enhance = ta => {
ta.dataset.cmApplied = '1';
const mode = detectMode(ta);

const wrapper = document.createElement('div');
wrapper.className = 'cm-wrapper';
ta.parentNode.insertBefore(wrapper, ta);
wrapper.appendChild(ta);

const toolbar = document.createElement('div');
toolbar.className = 'cm-toolbar';
toolbar.innerHTML = `
<button type="button" class="cm-btn" data-cm-action="wrap">Toggle Wrap</button>
<button type="button" class="cm-btn" data-cm-action="expand">Expand</button>
<span style="opacity:.7">Mode: ${mode}</span>
<button type="button" class="cm-btn cm-font-minus">A-</button>
<button type="button" class="cm-btn cm-font-plus">A+</button>
`;
wrapper.insertBefore(toolbar, ta);

const cm = CodeMirror.fromTextArea(ta, {
mode,
theme: 'material',
lineNumbers: true,
lineWrapping: false,
tabSize: 2,
indentUnit: 2,
matchBrackets: true,
autoCloseBrackets: true,
autoCloseTags: true,
viewportMargin: Infinity
});

ta._cmInstance = cm;

// Sync everywhere: keystroke, blur, form submit
cm.on('change', () => { cm.save(); triggerEvents(cm.getTextArea()); });
cm.on('blur', () => { cm.save(); triggerEvents(cm.getTextArea()); });
const form = ta.closest('form');
if (form) form.addEventListener('submit', () => { cm.save(); triggerEvents(cm.getTextArea()); });

// Toolbar actions
toolbar.addEventListener('click', e => {
const btn = e.target.closest('.cm-btn');
if (!btn) return;
const action = btn.dataset.cmAction;
if (action === 'wrap') cm.setOption('lineWrapping', !cm.getOption('lineWrapping'));
if (action === 'expand') {
const el = cm.getWrapperElement();
el.style.height = el.style.height === '90vh' ? '600px' : '80vh';
cm.refresh();
}
});

// Font size buttons
let currentSize = 12;
toolbar.querySelector('.cm-font-minus').onclick = () => {
currentSize = Math.max(10, currentSize - 1);
cm.getWrapperElement().style.fontSize = currentSize + 'px';
cm.refresh();
};
toolbar.querySelector('.cm-font-plus').onclick = () => {
currentSize = Math.min(24, currentSize + 1);
cm.getWrapperElement().style.fontSize = currentSize + 'px';
cm.refresh();
};

// Attach Save listeners immediately
attachSaveListeners(cm);
};

const scan = () => {
document.querySelectorAll('textarea').forEach(ta => {
if (isTextAreaCandidate(ta)) enhance(ta);
});
};

scan();

// Observe SPA/admin dynamic content
const mo = new MutationObserver(() => {
scan();
document.querySelectorAll('textarea[data-cm-applied="1"]').forEach(ta => {
if (ta._cmInstance) attachSaveListeners(ta._cmInstance);
});
});
mo.observe(document.documentElement, { childList: true, subtree: true });
})();